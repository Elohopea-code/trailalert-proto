<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TrailAlert</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap');
  body{margin:0;overflow:hidden;height:100vh;background:#000;font-family:'Inter',sans-serif}
  #map{width:100%;height:100vh}
  .title{position:fixed;top:14px;left:50%;transform:translateX(-50%);font-size:20px;font-weight:700;color:#30d158;z-index:1001}
  .fab-container{position:fixed;right:16px;bottom:28px;z-index:1001;display:flex;flex-direction:column;gap:15px}
  .fab{width:50px;height:50px;border-radius:50%;background:#30d158;color:white;font-size:26px;border:none;box-shadow:0 8px 28px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;transition:.2s}
  .fab:active{transform:scale(0.92)}
  .fab.active{background:#1a8a1a;box-shadow:0 0 0 5px rgba(48,209,88,0.4)}
  .hint{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#30d158;padding:11px 28px;border-radius:24px;font-size:15px;z-index:999;display:none;font-weight:600}
  #chat-panel{position:fixed;bottom:0;left:0;right:0;height:78vh;background:#e8f5e8;border-radius:26px 26px 0 0;display:none;z-index:1100;flex-direction:column;box-shadow:0 -12px 40px rgba(0,0,0,0.7)}
  #chat-header{padding:16px;color:#30d158;font-size:19px;font-weight:600;text-align:center;position:relative;background:#30d158;color:white}
  #close-chat{position:absolute;right:16px;top:12px;font-size:28px;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.25);display:flex;align-items:center;justify-content:center}
  #chat-box{flex:1;overflow-y:auto;padding:16px 12px;background:#e8f5e8}
  .msg-row{display:flex;margin:14px 8px;align-items:flex-end;gap:12px;max-width:82%}
  .msg-row.sent{flex-direction:row-reverse;margin-left:auto}
  .bubble{padding:11px 17px;border-radius:20px;font-size:16px;line-height:1.44;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
  .bubble.sent{background:#30d158;color:white;border-bottom-right-radius:6px}
  .bubble.received{background:white;color:black;border-bottom-left-radius:6px}
  .time{font-size:11px;opacity:0.7;margin-top:5px;text-align:right}
  .avatar{width:36px;height:36px;border-radius:50%;background:#666;color:white;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .avatar.sent{background:#30d158}
  #chat-input-container{display:flex;padding:12px 16px;background:#e8f5e8;gap:12px;align-items:center}
  #chat-input{flex:1;padding:14px 18px;background:white;border:none;border-radius:24px;color:black;font-size:16px;outline:none}
  #send-btn{width:68px;height:50px;border-radius:25px;background:#30d158;color:white;font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center}
  .notification{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:12px 32px;border-radius:24px;font-weight:600;font-size:17px;z-index:1200;display:none;box-shadow:0 6px 25px rgba(0,0,0,0.6)}
  .warning{background:#f97316;color:white}
  .critical{background:#ff453a;color:white}
  .fixed-size-icon{background:transparent !important;box-shadow:none !important}
</style>
</head>
<body>

<div id="map"></div>
<div class="title">TrailAlert</div>

<div class="fab-container">
  <button class="fab" id="big-btn"     title="Big game zone"><i class="fa-solid fa-crosshairs"></i></button>
  <button class="fab" id="small-btn"   title="Small game zone"><i class="fa-solid fa-dove"></i></button>
  <button class="fab" id="predator-btn" title="Predator sighting"><i class="fa-solid fa-paw"></i></button>
  <button class="fab" onclick="toggleChat()" title="Team chat"><i class="fa-solid fa-comment-dots"></i></button>
</div>

<div id="hint" class="hint"></div>

<div id="chat-panel">
  <div id="chat-header">Team Chat <div id="close-chat" onclick="toggleChat()">X</div></div>
  <div id="chat-box">
    <div class="msg-row">
      <div class="avatar">H</div>
      <div class="bubble received">Welcome!<br>Stag = big game zone · Dove = small game zone · Paw = predator sighting<div class="time">now</div></div>
    </div>
  </div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type a message...">
    <button id="send-btn" onclick="sendMessage()">Send</button>
  </div>
</div>

<div id="warning" class="notification warning">Approaching zone (~300 m)</div>
<div id="critical" class="notification critical">INSIDE HUNTING ZONE!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
  // Aluksi näytetään koko Suomi
  const map = L.map('map', {zoomControl:false}).setView([64.8, 26.0], 6);
  L.control.zoom({position:'topleft'}).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const zones = L.featureGroup().addTo(map);
  const predators = L.featureGroup().addTo(map);
  let drawPolygon = null;
  let predatorMode = false;
  let currentDrawType = null;
  let firstLocation = true;  // Lippu ensimmäiselle GPS-havainnolle

  const predatorIcon = L.divIcon({
    html: '<i class="fa-solid fa-paw" style="font-size:38px;color:#8b4513;"></i>',
    iconSize: [38,38],
    iconAnchor: [19,38],
    className: 'fixed-size-icon'
  });

  let userMarker = null;

  map.locate({setView: false, watch: true, enableHighAccuracy: true});

  map.on('locationfound', e => {
    if (!userMarker) {
      userMarker = L.circleMarker(e.latlng, {
        radius: 7, weight: 2, color: '#fff', fillColor: '#ff3b30', fillOpacity: 1
      }).addTo(map);
    }
    userMarker.setLatLng(e.latlng);

    // Ensimmäisellä kerralla zoomataan kauemmas (zoom 13 = hyvä yleiskatsaus)
    if (firstLocation) {
      map.setView(e.latlng, 13);  // <-- TÄMÄ ON SE PYÖRÄLÄ KAUEMPANA
      firstLocation = false;
    }

    // Lähestymisvaroitukset
    let near = false, inside = false;
    zones.eachLayer(l => {
      if (l.getLatLngs?.()[0]) {
        const c = l.getLatLngs()[0].map(p=>[p.lng,p.lat]); c.push(c[0]);
        const poly = turf.polygon([c]);
        const pt = turf.point([e.latlng.lng,e.latlng.lat]);
        if (turf.booleanPointInPolygon(pt,poly)) inside = true;
        else if (e.latlng.distanceTo(l.getLatLngs()[0][0]) < 300) near = true;
      }
    });
    document.getElementById('warning').style.display = near&&!inside ? 'block':'none';
    document.getElementById('critical').style.display = inside ? 'block':'none';
  });

  // --- Loput koodi täysin sama kuin ennen (toimii virheettömästi) ---
  function toggleDraw(type) {
    if (currentDrawType === type && drawPolygon) {
      drawPolygon.disable();
      drawPolygon = null;
      currentDrawType = null;
      document.getElementById(type + '-btn').classList.remove('active');
      document.getElementById('hint').style.display = 'none';
      return;
    }
    if (drawPolygon) drawPolygon.disable();
    drawPolygon = null;
    currentDrawType = type;
    document.querySelectorAll('.fab.active').forEach(b => b.classList.remove('active'));
    predatorMode = false;

    const color = type === 'big' ? '#ff453a' : '#f97316';
    drawPolygon = new L.Draw.Polygon(map, {
      showArea: false,
      shapeOptions: { color, weight: 6, fillOpacity: 0.32 }
    });
    drawPolygon.enable();

    document.getElementById(type + '-btn').classList.add('active');
    document.getElementById('hint').textContent = 'Drawing – tap button again to cancel';
    document.getElementById('hint').style.display = 'block';
  }

  document.getElementById('big-btn').onclick   = () => toggleDraw('big');
  document.getElementById('small-btn').onclick  = () => toggleDraw('small');

  document.getElementById('predator-btn').onclick = () => {
    if (drawPolygon) { drawPolygon.disable(); drawPolygon = null; currentDrawType = null; }
    document.querySelectorAll('.fab.active').forEach(b => b.classList.remove('active'));
    predatorMode = !predatorMode;
    const btn = document.getElementById('predator-btn');
    const hint = document.getElementById('hint');
    if (predatorMode) {
      btn.classList.add('active');
      hint.textContent = 'Predator mode – tap map';
      hint.style.display = 'block';
      setTimeout(() => hint.style.display = 'none', 3000);
    } else {
      btn.classList.remove('active');
      hint.style.display = 'none';
    }
  };

  map.on('draw:created', e => {
    if (drawPolygon) { drawPolygon.disable(); drawPolygon = null; }
    document.querySelectorAll('.fab.active').forEach(b => b.classList.remove('active'));
    document.getElementById('hint').style.display = 'none';

    const layer = e.layer;
    const color = currentDrawType === 'big' ? '#ff453a' : '#f97316';
    const name = currentDrawType === 'big' ? 'Big game' : 'Small game';
    layer.setStyle({color, weight:6, fillOpacity:0.32});
    layer.bindPopup(`<b>${name} zone</b><br><small>Tap to delete</small>`)
      .on('popupopen', () => {
        const btn = L.DomUtil.create('button', '');
        btn.innerHTML = 'Delete zone';
        btn.style.cssText = 'margin-top:8px;padding:8px;background:#ff453a;color:white;border:none;border-radius:8px;width:100%;font-weight:600';
        btn.onclick = () => { zones.removeLayer(layer); map.closePopup(); };
        document.querySelector('.leaflet-popup-content').appendChild(btn);
      });
    zones.addLayer(layer);
    currentDrawType = null;
  });

  map.on('click', e => {
    if (predatorMode) {
      const m = L.marker(e.latlng, {icon: predatorIcon}).addTo(predators);
      m.bindPopup('<b style="color:#30d158">PREDATOR</b><br><small>Tap to delete</small>');
      m.on('popupopen', () => {
        const btn = L.DomUtil.create('button', '');
        btn.innerHTML = 'Delete';
        btn.style.cssText = 'margin-top:8px;padding:8px;background:#ff453a;color:white;border:none;border-radius:8px;width:100%;font-weight:600';
        btn.onclick = () => { predators.removeLayer(m); map.closePopup(); };
        document.querySelector('.leaflet-popup-content').appendChild(btn);
      });
      m.openPopup();
    }
  });

  window.toggleChat = () => {
    const p = document.getElementById('chat-panel');
    p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
  };

  window.sendMessage = () => {
    const inp = document.getElementById('chat-input');
    const text = inp.value.trim(); if (!text) return;
    const box = document.getElementById('chat-box');
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    box.insertAdjacentHTML('beforeend', `
      <div class="msg-row sent">
        <div class="avatar sent">You</div>
        <div class="bubble sent">${text}<div class="time">${time}</div></div>
      </div>`);
    box.scrollTop = box.scrollHeight;
    inp.value = '';
  };

  document.getElementById('chat-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
</body>
</html>